<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>포켓몬 도감 - 반응형</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2125965839205311"
            crossorigin="anonymous"></script>

    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #0f172a;
            color: #d1d5db;
            overflow-x: hidden;
        }
        /* 메뉴 항목 기본 스타일 */
        .list-item { 
            @apply flex justify-between items-center w-full px-4 py-3 rounded-lg text-left cursor-pointer font-medium text-gray-200 hover:bg-gray-700;
            position: relative; /* 하단 표시 선을 위해 추가 */
        }
        /* 1차, 2차 메뉴 활성화 시 스타일 */
        .list-item.active { @apply bg-indigo-700 text-white; }
        /* 활성화된 메뉴 하단 표시 선 */
        .list-item.active::after { /* 추가 */
            content: '';
            position: absolute;
            left: 50%;
            bottom: -6px; /* 하단 간격 조절 */
            transform: translateX(-50%);
            width: 20px;
            height: 2px;
            background-color: #a78bfa; /* 활성화 색상과 유사하게 */
        }
        /* 3차 메뉴 활성화 시 스타일 (별도 색상) */
        .list-item.active-lev3 { background-color: #be185d; } /* Tailwind 기본 색상 아님 */
        .list-item.active-lev3::after { /* 3차 메뉴에도 표시하고 싶다면 추가 */
            content: '';
            position: absolute;
            left: 50%;
            bottom: -6px;
            transform: translateX(-50%);
            width: 20px;
            height: 2px;
            background-color: #f472b6; /* 활성화 색상과 유사하게 */
        }

        /* 포켓몬 타입별 태그 색상 */
        .tag { @apply inline-block px-3 py-1 rounded-full text-sm font-semibold; }
        .type-물 { background-color: #6390F0; color: white; }
        .type-땅 { background-color: #E0C068; color: white; }
        .type-드래곤 { background-color: #7038F8; color: white; }
        .type-에스퍼 { background-color: #F85888; color: white; }
        .type-한정뽑기 { background-color: #B8A038; color: white; } /* 캘린더 이벤트 타입 예시 */
        .type-랭킹전 { background-color: #C03028; color: white; } /* 캘린더 이벤트 타입 예시 */
        .type-이벤트 { background-color: #008000; color: white; } /* 캘린더 이벤트 타입 예시 */
        .type-정보 { background-color: #6890F0; color: white; } /* 캘린더 이벤트 타입 예시 */
        .type-레이드 { background-color: #705898; color: white; } /* 캘린더 이벤트 타입 예시 */
        /* 여기에 필요한 다른 타입별 태그 스타일을 추가할 수 있습니다 */

        /* 팝업 창 스타일 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #1f2937; /* bg-gray-800 */
            padding: 1.5rem; /* p-6 */
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-xl */
            max-width: 24rem; /* max-w-sm */
            width: 90%; /* w-full (모바일 대응) */
            position: relative;
            color: #d1d5db;
        }
        .modal-close-btn {
            position: absolute;
            top: 0.75rem; /* top-3 */
            right: 0.75rem; /* right-3 */
            color: #9ca3af; /* text-gray-400 */
            font-size: 1.25rem; /* text-xl */
            cursor: pointer;
        }
        .modal-close-btn:hover {
            color: #ffffff; /* hover:text-white */
        }
        /* 클릭 가능한 상세 아이템 (룬, 칩, 아이템 이름) */
        .clickable-detail-item {
            cursor: pointer;
            text-decoration: underline;
            color: #60a5fa; /* hover:text-blue-400 와 유사 */
        }
        .clickable-detail-item:hover {
            color: #3b82f6; /* text-blue-500 */
        }
        /* 팝업 내 이미지 스타일 */
        .modal-image {
            max-width: 100px; /* 팝업 내 이미지 최대 너비 */
            height: auto;
            margin: 0 auto 1rem; /* 중앙 정렬 및 아래 여백 */
            display: block; /* 블록 요소로 만들어 margin: auto 적용 */
        }
        
        /* 모바일 메뉴 배경색 구분 (lg: 미만) */
        aside#lev1-list { background-color: #1a202c; } /* bg-gray-900보다 약간 밝게 */
        aside#lev2-list { background-color: #2d3748; } /* bg-gray-800보다 약간 밝게 */
        aside#lev3-list { background-color: #4a5568; } /* bg-gray-700보다 약간 밝게 */

        /* 모바일 메뉴 들여쓰기 (lg: 미만) */
        @media (max-width: 1023px) { /* lg: breakpoint 이하 */
            #lev2-list .list-item { padding-left: 2rem; } /* 기본 px-4 (1rem)에서 2rem 추가 */
            #lev3-list .list-item { padding-left: 3rem; } /* 기본 px-4 (1rem)에서 3rem 추가 */
        }
        /* 뒤로가기 버튼 스타일 */
        .back-button {
            @apply flex items-center bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg mb-2 cursor-pointer;
        }
    </style>
</head>
<body class="p-4 sm:p-6">
    <header class="text-center mb-6">
        <h1 class="text-3xl sm:text-4xl font-bold text-yellow-400">포켓몬 도감</h1>
        <p class="text-gray-400 mt-2">집중 모드 및 검색 기능</p>
    </header>

    <div class="max-w-xl mx-auto mb-6 relative">
        <div class="relative">
            <i id="search-icon" class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 cursor-pointer"></i>
            <input type="text" id="search-input" placeholder="포켓몬, 아이템, 룬 이름 등으로 검색..." class="w-full bg-gray-800 border border-gray-700 rounded-full py-3 pl-12 pr-4 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
        </div>
        <div id="search-results" class="hidden absolute top-full left-0 w-full bg-gray-900 border border-gray-700 rounded-lg mt-2 z-50"></div>
    </div>

    <div class="ad-container max-w-xl mx-auto mb-6 bg-gray-800 p-4 rounded-lg text-center text-gray-400">
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-2125965839205311"
             data-ad-slot="5532734526"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
    </div>


    <div class="flex flex-col lg:flex-row gap-4">
        <aside class="flex-grow space-y-2 lg:w-1/4" id="lev1-list"></aside>
        <aside class="flex-grow space-y-2 lg:w-1/4 hidden" id="lev2-list"></aside>
        <aside class="flex-grow space-y-2 lg:w-1/4 hidden" id="lev3-list"></aside>
        <main class="flex-grow lg:w-3/4" id="details-content">
            <p class="text-gray-400 text-center pt-10">좌측 메뉴에서 항목을 선택하거나, 상단에서 검색하세요.</p>
        </main>
    </div>

    <div class="ad-container max-w-xl mx-auto mt-6 bg-gray-800 p-4 rounded-lg text-center text-gray-400">
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-2125965839205311"
             data-ad-slot="9651108783"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
    </div>

    <div id="detail-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <button id="modal-close-btn" class="modal-close-btn"><i class="fas fa-times"></i></button>
            <h3 id="modal-title" class="text-xl font-bold mb-4 text-white"></h3>
            <img id="modal-image" class="modal-image hidden" alt="상세 이미지">
            <p id="modal-description" class="text-gray-300 text-sm"></p>
        </div>
    </div>


    <script src="data.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- 화면 크기 감지 헬퍼 함수 ---
            const isLargeScreen = () => window.innerWidth >= 1024; // Tailwind의 lg: breakpoint

            // data.js 파일이 제대로 로드되었는지 확인합니다.
            if (!window.pokemonData || pokemonData.length === 0) {
                console.error('data.js 로드 실패 또는 데이터 없음. data.js 파일이 올바른 위치에 있고, window.pokemonData로 시작하는지 확인하세요.');
                document.getElementById('details-content').innerHTML = '<p class="text-red-500 text-center">데이터를 불러올 수 없습니다. data.js 파일을 확인해주세요.</p>';
                return;
            }

            // --- DOM 요소 참조 ---
            const lev1Col = document.getElementById('lev1-list');
            const lev2Col = document.getElementById('lev2-list');
            const lev3Col = document.getElementById('lev3-list');
            const detailsCol = document.getElementById('details-content');

            // 모달 관련 DOM 요소 참조
            const detailModal = document.getElementById('detail-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalImage = document.getElementById('modal-image');
            const modalDescription = document.getElementById('modal-description');
            const modalCloseBtn = document.getElementById('modal-close-btn');

            // 현재 활성화된 메뉴 항목을 추적하기 위한 변수
            let currentActiveLev1Btn = null;
            let currentActiveLev2Btn = null;
            let currentActiveLev3Btn = null;

            // --- 화면 분할 레이아웃 관리 함수 ---
            // 모바일에서 한 단계씩 드릴 다운되도록 로직 변경
            function updateLayout(level) {
                // PC 화면에서는 기존 멀티 컬럼 레이아웃 유지
                if (isLargeScreen()) {
                    lev1Col.classList.remove('lg:w-1/4', 'lg:w-1/3', 'lg:w-1/2');
                    lev2Col.classList.remove('lg:w-1/4', 'lg:w-1/3', 'lg:w-1/2');
                    lev3Col.classList.remove('lg:w-1/4', 'lg:w-1/3', 'lg:w-1/2');
                    detailsCol.classList.remove('lg:w-1/4', 'lg:w-1/3', 'lg:w-1/2', 'lg:w-3/4', 'lg:w-2/3');

                    lev2Col.classList.add('hidden');
                    lev3Col.classList.add('hidden');
                    detailsCol.classList.add('hidden'); 

                    if (level === 1 || level === 4) { // 초기화면 또는 최종 선택 후: Lev1 + Details
                        lev1Col.classList.add('lg:w-1/4');
                        detailsCol.classList.remove('hidden');
                        detailsCol.classList.add('lg:w-3/4');
                        if (level === 1) detailsCol.innerHTML = '<p class="text-gray-400 text-center pt-10">좌측 메뉴에서 항목을 선택하거나, 상단에서 검색하세요.</p>';
                    } else if (level === 2) { // Lev1 클릭 후: Lev1 + Lev2 
                        lev1Col.classList.add('lg:w-1/4');
                        lev2Col.classList.remove('hidden');
                        lev2Col.classList.add('lg:w-3/4');
                        lev3Col.innerHTML = '';
                        detailsCol.innerHTML = '';
                    } else if (level === 3) { // Lev2 클릭 후: Lev1 + Lev2 + Lev3
                        lev1Col.classList.add('lg:w-1/4');
                        lev2Col.classList.remove('hidden');
                        lev2Col.classList.add('lg:w-1/4');
                        lev3Col.classList.remove('hidden');
                        lev3Col.classList.add('lg:w-2/4');
                        detailsCol.innerHTML = '';
                    }
                } else { // 모바일 화면 (<lg) 에서는 한 컬럼만 보이도록 처리
                    lev1Col.classList.add('hidden');
                    lev2Col.classList.add('hidden');
                    lev3Col.classList.add('hidden');
                    detailsCol.classList.add('hidden');
                    
                    if (level === 1) { // 초기화면: Lev1만 보임
                        lev1Col.classList.remove('hidden');
                        detailsCol.classList.remove('hidden'); // 모바일에서도 초기에는 Details 영역은 보이게
                        detailsCol.innerHTML = '<p class="text-gray-400 text-center pt-10">좌측 메뉴에서 항목을 선택하거나, 상단에서 검색하세요.</p>';
                    } else if (level === 2) { // Lev1 클릭 후: Lev2만 보임 (Lev1 숨김)
                        lev2Col.classList.remove('hidden');
                    } else if (level === 3) { // Lev2 클릭 후: Lev3만 보임 (Lev2 숨김)
                        lev3Col.classList.remove('hidden');
                    } else if (level === 4) { // 최종 선택 후: Details만 보임 (모든 메뉴 숨김)
                        detailsCol.classList.remove('hidden');
                    }
                }
                
                // 광고를 다시 로드 시도
                refreshAds();
            }

            // --- 광고 새로고침 함수 ---
            function refreshAds() {
                // 사용자가 광고 비활성화 상태가 아닐 때만 광고를 새로 로드 시도
                if (!isUserAdDisabled()) {
                    try {
                        // 페이지에 있는 모든 'adsbygoogle' 인스턴스를 다시 푸시하여 광고 새로고침 요청
                        (window.adsbygoogle = window.adsbygoogle || []).push({});
                        console.log("애드센스 광고 새로고침 요청됨.");
                    } catch (e) {
                        console.error("애드센스 광고 새로고침 중 오류 발생:", e);
                    }
                } else {
                    console.log("사용자 광고 비활성화 상태이므로 광고 새로고침 건너뜜.");
                }
            }


            // --- 메뉴 렌더링 함수들 ---

            // "네비게이션" 버튼 생성 함수 (뒤로가기, 목록으로 돌아가기 등)
            function createNavButton(type, targetLevel, currentKey, currentValue) {
                const button = document.createElement('button');
                button.className = 'back-button'; // CSS 클래스 적용
                
                if (type === 'back') { // Lev2 -> Lev1 또는 Lev3 -> Lev2
                    button.innerHTML = '<i class="fas fa-chevron-left mr-2"></i><span>뒤로</span>';
                } else if (type === 'toList') { // Lev4 (상세 화면) -> 메인 목록
                    button.innerHTML = '<i class="fas fa-list mr-2"></i><span>목록으로 돌아가기</span>';
                }

                button.addEventListener('click', () => {
                    // 현재 활성화된 메뉴 버튼 리셋
                    if (currentActiveLev2Btn) currentActiveLev2Btn.classList.remove('active');
                    if (currentActiveLev3Btn) currentActiveLev3Btn.classList.remove('active-lev3');

                    if (type === 'back') { 
                        if (targetLevel === 1) { // Lev2에서 Lev1으로 돌아감
                            updateLayout(1); // Lev1 + Details 모드
                            lev2Col.innerHTML = ''; // 현재 2단계 목록 비우기
                            lev3Col.innerHTML = ''; // 3단계 목록 비우기
                            // 1차 메뉴 활성화 상태 유지
                            if (currentActiveLev1Btn) currentActiveLev1Btn.classList.add('active'); 
                        } else if (targetLevel === 2) { // Lev3에서 Lev2으로 돌아감
                            updateLayout(2); // Lev1 + Lev2 모드
                            lev3Col.innerHTML = ''; // 3단계 목록 비우기
                            renderLev2Dispatcher(currentKey); // Lev2 목록 다시 그리기 (active 상태 유지를 위해)
                            // 2차 메뉴 활성화 상태 유지
                            if (currentActiveLev2Btn) currentActiveLev2Btn.classList.add('active');
                        }
                    } else if (type === 'toList') { // 상세 화면(Lev4)에서 메인(Lev1)으로 돌아가기
                        updateLayout(1); // Go back to initial Lev1 + Details (empty) view
                        lev2Col.innerHTML = ''; // Clear other columns
                        lev3Col.innerHTML = '';
                        // 1차 메뉴 활성화 상태 유지 (이전 상태로 돌아가므로)
                        if (currentActiveLev1Btn) currentActiveLev1Btn.classList.add('active'); 
                    }
                });
                return button;
            }

            // 1차 메뉴 (카테고리) 초기화
            const categories = { 
                type: '포켓몬 타입', 
                grade: '포켓몬 등급', 
                item: '아이템', 
                rune: '룬', 
                chip: '칩', 
                team: '추천 덱',
                calendar: '캘린더', // 새로운 카테고리
                tip: '팁 & 노하우' // 새로운 카테고리
            };
            const lev1List = document.getElementById('lev1-list');

            for (const key in categories) {
                const button = document.createElement('button');
                button.className = 'list-item';
                button.innerHTML = `<span>${categories[key]}</span><i class="fas fa-chevron-right text-xs text-gray-400"></i>`;
                button.dataset.key = key; // 각 버튼에 어떤 카테고리인지 저장

                button.addEventListener('click', () => {
                    // 1차 메뉴 활성화 상태 관리
                    if (currentActiveLev1Btn) {
                        currentActiveLev1Btn.classList.remove('active');
                    }
                    button.classList.add('active');
                    currentActiveLev1Btn = button;

                    // 2차, 3차 메뉴 활성화 상태 초기화
                    currentActiveLev2Btn = null;
                    currentActiveLev3Btn = null;
                    
                    updateLayout(2); // 레이아웃을 Lev1 + Lev2 모드로 변경
                    renderLev2Dispatcher(key); // 2차 메뉴 그리기 함수 호출 (디스패처)
                });
                lev1List.appendChild(button); // 1차 메뉴 목록에 버튼 추가
            }

            // 2차 메뉴 디스패처 (카테고리별 2차 메뉴 렌더링 분기)
            function renderLev2Dispatcher(categoryKey) {
                const list = document.getElementById('lev2-list');
                list.innerHTML = ''; // 기존 2차 메뉴 내용 초기화
                
                if (!isLargeScreen()) { // 모바일에서는 뒤로가기 버튼 추가
                    list.appendChild(createNavButton('back', 1, categoryKey));
                }

                if (categoryKey === 'calendar') {
                    renderCalendarMonths(list);
                } else if (categoryKey === 'tip') {
                    renderTipCategories(list);
                } else if (['item', 'rune', 'chip'].includes(categoryKey)) { // 아이템, 룬, 칩 카테고리
                    // 해당 아이템/룬/칩의 고유 이름을 가져옴 (예: "먹다남은 사과", "전투광")
                    const values = [...new Set(window.pokemonData.map(p => p[categoryKey]).flat().filter(Boolean).map(s => {
                        return (categoryKey === 'rune' || categoryKey === 'chip') ? s.split(' ')[0] : s;
                    }))];

                    values.forEach(value => {
                        const button = document.createElement('button');
                        button.className = 'list-item';
                        button.innerHTML = `<span>${value}</span><i class="fas fa-chevron-right text-xs text-gray-400"></i>`;
                        button.addEventListener('click', () => {
                            // 2차 메뉴 활성화 상태 관리
                            if (currentActiveLev2Btn) {
                                currentActiveLev2Btn.classList.remove('active');
                            }
                            button.classList.add('active');
                            currentActiveLev2Btn = button;

                            updateLayout(4); // 아이템/룬/칩은 바로 상세 화면으로 이동 (Lev1 + Details)
                            
                            // 해당 아이템/룬/칩 객체를 직접 찾아서 전달
                            let itemDetailObject = null;
                            if (categoryKey === 'item') itemDetailObject = window.itemDetails[value];
                            else if (categoryKey === 'rune') itemDetailObject = window.runeDetails[value];
                            else if (categoryKey === 'chip') itemDetailObject = window.chipDetails[value];

                            if (itemDetailObject) {
                                renderDetailsDispatcher(itemDetailObject, categoryKey + 'Detail'); // 예: 'itemDetail'
                            } else {
                                detailsCol.innerHTML = '<p class="text-gray-400 text-center pt-10">상세 정보를 찾을 수 없습니다.</p>';
                            }
                        });
                        list.appendChild(button);
                    });
                } else { // 기존 포켓몬 관련 카테고리 (type, grade, team)
                    const values = [...new Set(window.pokemonData.map(p => p[categoryKey]).flat().filter(Boolean))]; // 여기서는 수량 파싱 필요 없음
                    values.forEach(value => {
                        const button = document.createElement('button');
                        button.className = 'list-item';
                        button.innerHTML = `<span>${value}</span><i class="fas fa-chevron-right text-xs text-gray-400"></i>`;
                        button.addEventListener('click', () => {
                            // 2차 메뉴 활성화 상태 관리
                            if (currentActiveLev2Btn) {
                                currentActiveLev2Btn.classList.remove('active');
                            }
                            button.classList.add('active');
                            currentActiveLev2Btn = button;

                            // 3차 메뉴 활성화 상태 초기화
                            currentActiveLev3Btn = null;

                            updateLayout(3); // 레이아웃을 Lev1 + Lev2 + Lev3 모드로 변경
                            renderLev3Dispatcher(categoryKey, value); // 3차 메뉴 디스패처 호출 (월 전달)
                        });
                        list.appendChild(button);
                    });
                }
            }
            
            // 3차 메뉴 디스패처 (카테고리별 3차 메뉴 렌더링 분기)
            function renderLev3Dispatcher(categoryKey, selectedValue) {
                const list = document.getElementById('lev3-list');
                list.innerHTML = ''; // 기존 3차 메뉴 내용 초기화

                if (!isLargeScreen()) { // 모바일에서는 뒤로가기 버튼 추가
                    list.appendChild(createNavButton('back', 2, categoryKey, selectedValue));
                }

                if (categoryKey === 'calendar') {
                    renderCalendarEventsForMonth(list, selectedValue); // selectedValue는 'YYYY-MM'
                } else if (categoryKey === 'tip') {
                    renderTipTitles(list, selectedValue); // selectedValue는 팁 카테고리
                } else { // 기존 포켓몬 관련 카테고리 (type, grade, item, rune, chip, team)
                    let filtered = [];
                    // 룬/칩/아이템 카테고리는 이제 2단계에서 바로 상세로 가므로, 여기서는 포켓몬 데이터만 처리
                    if (categoryKey === 'rune' || categoryKey === 'chip') {
                         // 룬/칩은 이름만으로 필터링 (예: "전투광 3개" -> "전투광")
                        filtered = window.pokemonData.filter(p => p[categoryKey] && p[categoryKey].some(item => item.split(' ')[0] === selectedValue));
                    } else if (categoryKey === 'item') {
                         // 아이템은 이름이 정확히 일치하는지 확인
                        filtered = window.pokemonData.filter(p => p[categoryKey] === selectedValue);
                    } else {
                        // 그 외 (type, grade, team)는 기존 방식 유지
                        filtered = window.pokemonData.filter(p => (Array.isArray(p[categoryKey]) ? p[categoryKey].includes(selectedValue) : p[categoryKey] === selectedValue));
                    }


                    if (filtered.length === 0) {
                        const p = document.createElement('p');
                        p.className = 'text-gray-500 px-4 py-3 text-sm';
                        p.textContent = '해당하는 포켓몬이 없습니다.';
                        list.appendChild(p);
                    }
                    filtered.forEach(p => {
                        const button = document.createElement('button');
                        button.className = 'list-item';
                        button.textContent = p.name;
                        button.addEventListener('click', () => {
                            // 3차 메뉴 활성화 상태 관리
                            if (currentActiveLev3Btn) {
                                currentActiveLev3Btn.classList.remove('active-lev3');
                            }
                            button.classList.add('active-lev3');
                            currentActiveLev3Btn = button;

                            updateLayout(4); // 레이아웃을 최종 선택 모드 (Lev1 + Details)로 변경
                            renderDetailsDispatcher(p, 'pokemon'); // 상세 정보 디스패처 호출
                        });
                        list.appendChild(button);
                    });
                }
            }


            // --- 새로운 카테고리 (캘린더, 팁&노하우) 렌더링 함수들 ---

            // 캘린더: 2차 메뉴 - 년도 및 월 목록
            function renderCalendarMonths(list) {
                const uniqueMonths = [...new Set(window.calendarEvents.map(event => event.date.substring(0, 7)))]; // INSEE-MM 형식
                uniqueMonths.sort().forEach(month => {
                    const button = document.createElement('button');
                    button.className = 'list-item';
                    button.innerHTML = `<span>${month.replace('-', '년 ')}월</span><i class="fas fa-chevron-right text-xs text-gray-400"></i>`;
                    button.addEventListener('click', () => {
                        if (currentActiveLev2Btn) { currentActiveLev2Btn.classList.remove('active'); }
                        button.classList.add('active');
                        currentActiveLev2Btn = button;
                        currentActiveLev3Btn = null;
                        updateLayout(3);
                        renderLev3Dispatcher('calendar', month); // 3차 메뉴 디스패처 호출 (월 전달)
                    });
                    list.appendChild(button);
                });
                if (uniqueMonths.length === 0) {
                    list.innerHTML = '<p class="text-gray-500 px-4 py-3 text-sm">등록된 캘린더 이벤트가 없습니다.</p>';
                }
            }

            // 캘린더: 3차 메뉴 - 특정 월의 이벤트 목록
            function renderCalendarEventsForMonth(list, selectedMonth) {
                const filteredEvents = window.calendarEvents.filter(event => event.date.startsWith(selectedMonth));
                filteredEvents.sort((a, b) => a.date.localeCompare(b.date)).forEach(event => {
                    const button = document.createElement('button');
                    button.className = 'list-item';
                    button.innerHTML = `<span>${event.date.substring(5).replace('-', '월 ')}일: ${event.title}</span>`;
                    button.addEventListener('click', () => {
                        if (currentActiveLev3Btn) { currentActiveLev3Btn.classList.remove('active-lev3'); }
                        button.classList.add('active-lev3');
                        currentActiveLev3Btn = button;
                        updateLayout(4);
                        renderDetailsDispatcher(event, 'calendarEvent'); // 상세 정보 디스패처 호출
                    });
                    list.appendChild(button);
                });
                 if (filteredEvents.length === 0) {
                    list.innerHTML = '<p class="text-gray-500 px-4 py-3 text-sm">해당 월의 이벤트가 없습니다.</p>';
                }
            }

            // 팁 & 노하우: 2차 메뉴 - 팁 카테고리 목록
            function renderTipCategories(list) {
                const uniqueCategories = [...new Set(window.tipsAndKnowhow.map(tip => tip.category || '기타').filter(Boolean))]; // 카테고리 없으면 '기타'로
                uniqueCategories.sort().forEach(category => {
                    const button = document.createElement('button');
                    button.className = 'list-item';
                    button.innerHTML = `<span>${category}</span><i class="fas fa-chevron-right text-xs text-gray-400"></i>`;
                    button.addEventListener('click', () => {
                        if (currentActiveLev2Btn) { currentActiveLev2Btn.classList.remove('active'); }
                        button.classList.add('active');
                        currentActiveLev2Btn = button;
                        currentActiveLev3Btn = null;
                        updateLayout(3);
                        renderLev3Dispatcher('tip', category); // 3차 메뉴 디스패처 호출 (카테고리 전달)
                    });
                    list.appendChild(button);
                });
                if (uniqueCategories.length === 0) {
                    list.innerHTML = '<p class="text-gray-500 px-4 py-3 text-sm">등록된 팁 카테고리가 없습니다.</p>';
                }
            }

            // 팁 & 노하우: 3차 메뉴 - 특정 카테고리의 팁 제목 목록
            function renderTipTitles(list, selectedCategory) {
                const filteredTips = window.tipsAndKnowhow.filter(tip => (tip.category || '기타') === selectedCategory);
                filteredTips.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(tip => { // 최신 날짜순 정렬
                    const button = document.createElement('button');
                    button.className = 'list-item';
                    button.innerHTML = `<span>${tip.title}</span>`;
                    button.addEventListener('click', () => {
                        if (currentActiveLev3Btn) { currentActiveLev3Btn.classList.remove('active-lev3'); }
                        button.classList.add('active-lev3');
                        currentActiveLev3Btn = button;
                        updateLayout(4);
                        renderDetailsDispatcher(tip, 'tip'); // 상세 정보 디스패처 호출
                    });
                    list.appendChild(button);
                });
                if (filteredTips.length === 0) {
                    list.innerHTML = '<p class="text-gray-500 px-4 py-3 text-sm">해당 카테고리의 팁이 없습니다.</p>';
                }
            }


            // --- 상세 정보 렌더링 디스패처 ---
            function renderDetailsDispatcher(item, itemType) {
                const detail = document.getElementById('details-content');
                detail.innerHTML = ''; // 기존 내용 비우기

                // 모든 상세 화면에 "목록으로 돌아가기" 버튼 추가
                const backBtnContainer = document.createElement('div');
                backBtnContainer.className = 'mb-4';
                backBtnContainer.appendChild(createNavButton('toList', null, null, null)); 
                detail.appendChild(backBtnContainer); // 먼저 버튼 컨테이너를 추가

                // 실제 콘텐츠를 담을 임시 div 생성
                const contentDiv = document.createElement('div');


                if (itemType === 'pokemon') {
                    renderPokemonDetails(item, contentDiv);
                } else if (itemType === 'calendarEvent') {
                    renderCalendarEventDetails(item, contentDiv);
                } else if (itemType === 'tip') {
                    renderTipDetails(item, contentDiv);
                } else if (itemType === 'itemDetail') { // 아이템 상세
                    renderItemRuneChipDetails(item, contentDiv, '아이템', item.name);
                } else if (itemType === 'runeDetail') { // 룬 상세
                    renderItemRuneChipDetails(item, contentDiv, '룬', item.name);
                } else if (itemType === 'chipDetail') { // 칩 상세
                    renderItemRuneChipDetails(item, contentDiv, '칩', item.name);
                } else {
                    const errorMessage = document.createElement('p');
                    errorMessage.className = 'text-red-500 text-center';
                    errorMessage.textContent = '선택된 항목의 상세 정보를 표시할 수 없습니다.';
                    contentDiv.appendChild(errorMessage);
                }
                detail.appendChild(contentDiv); // 콘텐츠를 담은 div를 추가
            }

            // --- 각 항목별 상세 정보 렌더링 함수 ---

            // 포켓몬 상세 정보 렌더링 (팝업 클릭 기능 추가)
            function renderPokemonDetails(pokemon, detailElement) {
                
                let skillsHtml = '';
                if (pokemon.skills && pokemon.skills.length > 0) {
                    skillsHtml += `<h3 class="text-xl font-bold mt-4 mb-2">기술</h3>`;
                    pokemon.skills.forEach(skill => {
                        // **오류 수정됨: 잘못된 문자열 제거**
                        skillsHtml += `<div class="bg-gray-700 p-3 rounded-lg mb-2">
                                          <h4 class="font-semibold text-gray-200"><span class="math-inline">\{skill\.name\}</h4\>
<p class\="text\-gray\-400 text\-sm"\></span>{skill.description}</p></div>`; 
                        if (skill.parts && skill.parts.length > 0) {
                            skill.parts.forEach(part => {
                                skillsHtml += `<p class="text-gray-400 text-xs mt-1"><strong>${part.title}:</strong> ${part.text}</p>`;
                            });
                        }
                    });
                }

                let natureHtml = pokemon.nature ? `<p class="text-gray-300 mt-2"><strong>성격:</strong> ${pokemon.nature.join(', ')}</p>` : '';
                let buildHtml = pokemon.build ? `<p class="text-gray-300"><strong>육성:</strong> ${pokemon.build.join(', ')}</p>` : '';

                // 아이템 정보 클릭 가능하게 변경 (설명은 팝업으로 이동)
                let itemHtml = '';
                if (pokemon.item && window.itemDetails[pokemon.item]) { 
                    itemHtml = `<h3 class="text-xl font-bold mt-4 mb-2">추천 아이템</h3>
                                <div class="bg-gray-700 p-3 rounded-lg">
                                    <h4 class="font-semibold text-gray-200 clickable-detail-item" 
                                        data-detail-type="item" data-detail-name="${pokemon.item}">
                                        ${pokemon.item}
                                    </h4>
                                </div>`;
                }

                // 룬 정보 클릭 가능하게 변경 (설명은 팝업으로 이동)
                let runesHtml = '';
                if (pokemon.runes && pokemon.runes.length > 0) {
                    runesHtml += '<h3 class="text-xl font-bold mt-4 mb-2">추천 룬</h3><div class="space-y-2">';
                    pokemon.runes.forEach(fullRuneName => { // "전투광 3개" 전체 문자열
                        const runeBaseName = fullRuneName.split(' ')[0]; // "전투광"만 추출
                        if (window.runeDetails[runeBaseName]) {
                            runesHtml += `<div class="bg-gray-700 p-3 rounded-lg">
                                            <h4 class="font-semibold text-gray-200 clickable-detail-item"
                                                data-detail-type="rune" data-detail-name="${runeBaseName}">
                                                ${fullRuneName}
                                            </h4>
                                          </div>`;
                        }
                    });
                    runesHtml += '</div>';
                }

                // 칩 정보 클릭 가능하게 변경 (설명은 팝업으로 이동)
                let chipsHtml = '';
                if (pokemon.chips && pokemon.chips.length > 0) {
                    chipsHtml += '<h3 class="text-xl font-bold mt-4 mb-2">추천 칩</h3><div class="space-y-2">';
                    pokemon.chips.forEach(fullChipName => { // "귀갑 2개" 전체 문자열
                        const chipBaseName = fullChipName.split(' ')[0]; // "귀갑"만 추출
                        if (window.chipDetails[chipBaseName]) {
                            chipsHtml += `<div class="bg-gray-700 p-3 rounded-lg">
                                            <h4 class="font-semibold text-gray-200 clickable-detail-item"
                                                data-detail-type="chip" data-detail-name="${chipBaseName}">
                                                ${fullChipName}
                                            </h4>
                                          </div>`;
                        }
                    });
                    chipsHtml += '</div>';
                }

                const contentHtml = `
                  <h2 class="text-2xl font-bold mb-4">${pokemon.name}</h2>
                  ${pokemon.image ? `<img src="${pokemon.image}" alt="${pokemon.name}" class="w-full h-48 object-contain mb-4 rounded-lg bg-gray-800 p-2">` : ''}
                  <p class="text-gray-300 italic mb-4"><span class="math-inline">\{pokemon\.description\}</p\> 
<div class\="flex flex\-wrap gap\-2 mb\-4"\>
<span class\="tag type\-</span>{pokemon.type}"><span class="math-inline">\{pokemon\.type\}</span\> 
<span class\="tag bg\-gray\-600 text\-white"\></span>{pokemon.grade} 등급</span>
                  </div>
                  ${natureHtml}
                  ${buildHtml}
                  ${skillsHtml}
                  ${itemHtml}
                  ${runesHtml}
                  ${chipsHtml}
                `;
                detailElement.innerHTML += contentHtml; // 기존 뒤로가기 버튼 뒤에 추가
            }

            // 캘린더 이벤트 상세 정보 렌더링
            function renderCalendarEventDetails(event, detailElement) {
                const contentHtml = `
                    <h2 class="text-2xl font-bold mb-4">${event.title}</h2>
                    ${event.imageUrl ? `<img src="${event.imageUrl}" alt="${event.title}" class="w-full h-48 object-contain mb-4 rounded-lg bg-gray-800 p-2">` : ''}
                    <div class="flex gap-2 mb-4">
                        <span class="tag type-<span class="math-inline">\{event\.type \|\| '이벤트'\}"\></span>{event.type || '이벤트'}</span> 
                        <span class="tag bg-gray-600 text-white">${event.date}</span>
                        ${event.time ? `<span class="tag bg-gray-600 text-white">${event.time}</span>` : ''}
                    </div>
                    <p class="text-gray-300 mb-4">${event.description || '상세 내용이 없습니다.'}</p>
                `;
                detailElement.innerHTML += contentHtml;
            }

            // 팁 & 노하우 상세 정보 렌더링
            function renderTipDetails(tip, detailElement) {
                const contentHtml = `
                    <h2 class="text-2xl font-bold mb-4">${tip.title}</h2>
                    <div class="flex flex-wrap gap-2 mb-4 text-gray-400 text-sm">
                        ${tip.category ? `<span>카테고리: ${tip.category}</span>` : ''}
                        ${tip.author ? `<span>작성자: ${tip.author}</span>` : ''}
                        ${tip.date ? `<span>날짜: ${tip.date}</span>` : ''}
                    </div>
                    <div class="bg-gray-700 p-4 rounded-lg text-gray-300 leading-relaxed">
                        ${tip.content || '내용이 없습니다.'}
                    </div>
                `;
                detailElement.innerHTML += contentHtml;
            }

            // 아이템/룬/칩 상세 정보 렌더링 (새로 추가)
            function renderItemRuneChipDetails(detailItem, detailElement, itemCategoryName) {
                const contentHtml = `
                    <h2 class="text-2xl font-bold mb-4">${itemCategoryName} - ${detailItem.name || ''}</h2>
                    ${detailItem.imageUrl ? `<img src="${detailItem.imageUrl}" alt="${detailItem.name || itemCategoryName}" class="w-full h-48 object-contain mb-4 rounded-lg bg-gray-800 p-2">` : ''}
                    <p class="text-gray-300 mb-4">${detailItem.description || '상세 설명이 없습니다.'}</p>
                `;
                detailElement.innerHTML += contentHtml;
            }


            // --- 모달(팝업) 관련 함수 ---

            // 팝업 열기
            function showDetailPopup(type, name) {
                let detailData = null; // 선택된 아이템/룬/칩의 상세 데이터
                if (type === 'item' && window.itemDetails[name]) {
                    detailData = window.itemDetails[name];
                } else if (type === 'rune' && window.runeDetails[name]) {
                    detailData = window.runeDetails[name];
                } else if (type === 'chip' && window.chipDetails[name]) {
                    detailData = window.chipDetails[name];
                }

                if (detailData) {
                    modalTitle.textContent = name;
                    modalDescription.textContent = detailData.description || '상세 설명이 없습니다.';
                    if (detailData.imageUrl) {
                        modalImage.src = detailData.imageUrl;
                        modalImage.classList.remove('hidden');
                    } else {
                        modalImage.classList.add('hidden');
                        modalImage.src = ''; // 이미지 URL 초기화
                    }
                    detailModal.classList.remove('hidden'); // 팝업 보이기
                } else {
                    // 데이터가 없는 경우 팝업 대신 콘솔 로그 또는 알림
                    console.warn(`상세 정보를 찾을 수 없습니다: 타입 ${type}, 이름 ${name}`);
                    // alert('상세 정보를 찾을 수 없습니다.');
                }
            }

            // 팝업 닫기
            function closeDetailPopup() {
                detailModal.classList.add('hidden'); // 팝업 숨기기
                modalTitle.textContent = '';
                modalDescription.textContent = '';
                modalImage.src = '';
                modalImage.classList.add('hidden');
            }

            // 팝업 닫기 버튼 클릭 이벤트
            modalCloseBtn.addEventListener('click', closeDetailPopup);

            // 팝업 바깥 영역 클릭 시 닫기
            detailModal.addEventListener('click', (event) => {
                // 모달 콘텐츠 영역을 클릭한 것이 아니라, 오버레이 영역을 클릭했을 때만 닫기
                if (event.target === detailModal) {
                    closeDetailPopup();
                }
            });

            // 포켓몬 상세 화면 내 클릭 가능한 아이템/룬/칩에 대한 이벤트 위임
            // detailsCol에 클릭 리스너를 붙여서 자식 요소의 클릭을 감지
            detailsCol.addEventListener('click', (event) => {
                const clickedElement = event.target;
                if (clickedElement.classList.contains('clickable-detail-item')) {
                    const type = clickedElement.dataset.detailType;
                    const name = clickedElement.dataset.detailName;
                    showDetailPopup(type, name);
                }
            });


            // --- 검색 기능 ---
            const searchInput = document.getElementById('search-input');
            const searchResultsDiv = document.getElementById('search-results');

            searchInput.addEventListener('input', () => {
                const query = searchInput.value.toLowerCase(); // 검색어를 소문자로 변환
                searchResultsDiv.innerHTML = ''; // 이전 검색 결과 초기화

                if (query.length < 2) { // 검색어가 2글자 미만이면 결과 숨기기
                    searchResultsDiv.classList.add('hidden');
                    return;
                }

                // 모든 데이터를 대상으로 검색
                const allSearchableItems = [
                    ...window.pokemonData.map(item => ({ ...item, _dataType: 'pokemon' })),
                    ...window.calendarEvents.map(item => ({ ...item, _dataType: 'calendarEvent' })),
                    ...window.tipsAndKnowhow.map(item => ({ ...item, _dataType: 'tip' }))
                ];

                const filteredResults = allSearchableItems.filter(item => {
                    // 각 아이템 타입별로 검색 필드를 확인
                    const nameMatch = item.name ? item.name.toLowerCase().includes(query) : false; // 포켓몬
                    const titleMatch = item.title ? item.title.toLowerCase().includes(query) : false; // 캘린더, 팁
                    const descriptionMatch = item.description ? item.description.toLowerCase().includes(query) : false; // 포켓몬, 캘린더
                    const contentMatch = item.content ? item.content.toLowerCase().includes(query) : false; // 팁
                    const categoryMatch = item.category ? item.category.toLowerCase().includes(query) : false; // 팁
                    const itemTypeMatch = item.item ? item.item.toLowerCase().includes(query) : false; // 포켓몬의 item
                    // 룬/칩 검색 시 "전투광 3개" -> "전투광"으로 파싱하여 검색
                    const runeMatch = item.runes ? item.runes.some(r => r.toLowerCase().split(' ')[0].includes(query)) : false;
                    const chipMatch = item.chips ? item.chips.some(c => c.toLowerCase().split(' ')[0].includes(query)) : false;
                    const teamMatch = item.team ? item.team.toLowerCase().includes(query) : false; // 포켓몬의 team
                    const gradeMatch = item.grade ? item.grade.toLowerCase().includes(query) : false; // 포켓몬의 grade

                    // 날짜 검색 (YYYY-MM-DD 형식)
                    const dateMatch = item.date ? item.date.toLowerCase().includes(query) : false;


                    return nameMatch || titleMatch || descriptionMatch || contentMatch || categoryMatch ||
                           itemTypeMatch || runeMatch || chipMatch || teamMatch || gradeMatch || dateMatch;
                });

                if (filteredResults.length > 0) {
                    filteredResults.forEach(item => {
                        const resultItem = document.createElement('button');
                        resultItem.className = 'list-item px-4 py-2 hover:bg-gray-700 block';
                        resultItem.textContent = item.name || item.title; // 포켓몬은 name, 나머지는 title
                        resultItem.addEventListener('click', () => {
                            updateLayout(4); // 검색 결과 클릭 시 최종 상세 화면으로
                            renderDetailsDispatcher(item, item._dataType); // 아이템 타입에 따라 상세 정보 렌더링
                            searchInput.value = item.name || item.title;
                            searchResultsDiv.classList.add('hidden');

                            if (currentActiveLev1Btn) currentActiveLev1Btn.classList.remove('active');
                            if (currentActiveLev2Btn) currentActiveLev2Btn.classList.remove('active');
                            if (currentActiveLev3Btn) currentActiveLev3Btn.classList.remove('active-lev3');
                        });
                        searchResultsDiv.appendChild(resultItem);
                    });
                    searchResultsDiv.classList.remove('hidden');
                } else {
                    const noResult = document.createElement('div');
                    noResult.className = 'px-4 py-2 text-gray-500 text-sm';
                    noResult.textContent = '검색 결과가 없습니다.';
                    searchResultsDiv.appendChild(noResult);
                    searchResultsDiv.classList.add('hidden');
                }
            });

            // 검색 결과 외 영역 클릭 시 검색 결과 숨기기
            document.addEventListener('click', (event) => {
                if (!searchInput.contains(event.target) && !searchResultsDiv.contains(event.target)) {
                    searchResultsDiv.classList.add('hidden');
                }
            });

            // --- 무효 트래픽 방어 기능 ---
            const MAX_CLICKS_PER_HOUR = 5; // 1시간 동안 허용되는 최대 클릭 횟수
            const CLICK_WINDOW_MS = 60 * 60 * 1000; // 1시간을 밀리초로 변환
            const STORAGE_KEY_CLICKS = 'ad_click_data'; // 클릭 데이터를 저장할 localStorage 키
            const STORAGE_KEY_DISABLED = 'ad_user_disabled'; // 광고를 숨길 사용자임을 저장할 localStorage 키

            // localStorage에서 클릭 데이터를 가져오는 함수
            function getClickData() {
                try {
                    const data = localStorage.getItem(STORAGE_KEY_CLICKS);
                    return data ? JSON.parse(data) : [];
                } catch (e) {
                    console.error("Error reading click data from localStorage:", e);
                    return [];
                }
            }

            // localStorage에 클릭 데이터를 저장하는 함수
            function saveClickData(data) {
                try {
                    localStorage.setItem(STORAGE_KEY_CLICKS, JSON.stringify(data));
                } catch (e) {
                    console.error("Error saving click data to localStorage:", e);
                }
            }

            // 사용자가 광고 비활성화 상태인지 확인하는 함수
            function isUserAdDisabled() {
                try {
                    return localStorage.getItem(STORAGE_KEY_DISABLED) === 'true';
                } catch (e) {
                    console.error("Error reading ad disabled status from localStorage:", e);
                    return false;
                }
            }

            // 사용자에게 광고를 비활성화하는 함수
            function disableAdsForUser() {
                try {
                    localStorage.setItem(STORAGE_KEY_DISABLED, 'true');
                    console.warn("경고: 비정상적인 광고 클릭 감지! 해당 사용자에게 광고를 비활성화합니다.");
                    // 사용자에게 알림을 줄 수도 있습니다. (예: alert("비정상적인 활동이 감지되어 광고가 일시적으로 중단됩니다."));
                } catch (e) {
                    console.error("Error disabling ads for user in localStorage:", e);
                }
            }

            // 모든 광고 컨테이너를 숨기는 함수
            function hideAllAdContainers() {
                const adContainers = document.querySelectorAll('.ad-container');
                adContainers.forEach(container => {
                    container.style.display = 'none'; // 광고 영역을 숨깁니다.
                });
            }

            // --- 초기 로드 시 레이아웃 및 광고 상태 설정 ---
            updateLayout(1); // 초기 레이아웃: Lev1 + Details (공란)

            if (isUserAdDisabled()) {
                hideAllAdContainers();
                console.log("이 사용자는 이전에 광고 비활성화 플래그가 설정되어 있습니다.");
            } else {
                // 광고 컨테이너 클릭 이벤트 리스너 설정
                const adContainers = document.querySelectorAll('.ad-container');
                adContainers.forEach(container => {
                    container.addEventListener('click', (event) => {
                        // 실제 광고(iframe) 내부 클릭은 감지하기 어렵지만, 광고 영역(div) 자체 클릭을 감지
                        // 즉, 사용자가 '광고가 있을 법한 위치'를 클릭한 횟수를 카운트
                        const currentTime = Date.now();
                        let clickData = getClickData();

                        // 1시간(CLICK_WINDOW_MS) 이내의 클릭만 유효하게 유지
                        clickData = clickData.filter(timestamp => (currentTime - timestamp) < CLICK_WINDOW_MS);

                        // 현재 클릭 타임스탬프 추가
                        clickData.push(currentTime);
                        saveClickData(clickData);

                        console.log(`광고 영역 클릭 감지. 현재 ${clickData.length}회 클릭 (1시간 이내).`);

                        // 클릭 횟수가 제한을 초과하면 광고 비활성화
                        if (clickData.length >= MAX_CLICKS_PER_HOUR) {
                            disableAdsForUser();
                            hideAllAdContainers();
                            // 선택적으로 사용자에게 메시지 표시
                            // alert("비정상적인 광고 클릭 활동이 감지되어, 광고가 더 이상 표시되지 않습니다.");
                        }
                    });
                });
            }
        });
    </script>
</body>
</html>