<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>포켓몬 도감 정보</title>
    <style>
        :root {
            --sidebar-width: 220px;
            --primary-color: #3498db;
            --background-color: #f0f2f5;
            --top-ad-banner-height: 90px; /* 광고 배너 높이 */
        }
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--background-color);
            /* 상단 고정 광고 배너만큼 콘텐츠 시작 위치를 내립니다. */
            padding-top: var(--top-ad-banner-height);
        }
        /* --- 상단 고정 광고 배너 --- */
        .top-ad-banner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: var(--top-ad-banner-height);
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 300;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .app-container { display: flex; height: calc(100vh - var(--top-ad-banner-height)); }
        .sidebar {
            width: var(--sidebar-width);
            background-color: #2c3e50;
            color: white; padding: 15px; flex-shrink: 0;
            overflow-y: auto; transition: transform 0.3s ease;
        }
        .sidebar h1 { font-size: 1.5em; text-align: center; margin-bottom: 20px; }
        .sidebar .nav-menu { list-style: none; padding: 0; margin: 0; }
        .sidebar .nav-menu li {
            padding: 12px 15px; margin-bottom: 5px; border-radius: 5px;
            cursor: pointer; transition: background-color 0.2s;
        }
        .sidebar .nav-menu li:hover { background-color: #34495e; }
        .sidebar .nav-menu li.active { background-color: var(--primary-color); }

        .main-content { flex-grow: 1; display: flex; overflow-x: hidden; }
        .content-column {
            min-width: 300px; background-color: white;
            border-right: 1px solid #e0e0e0;
            padding: 20px; overflow-y: auto;
        }
        .content-column h2 { margin-top: 0; }
        .list-item {
            padding: 12px; margin-bottom: 8px; border-radius: 4px;
            cursor: pointer; border: 1px solid #eee;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .list-item:hover { background-color: #f9f9f9; }
        .list-item.active {
            background-color: var(--primary-color); color: white;
            border-color: var(--primary-color);
        }
        .column-hidden { display: none; }

        /* --- 포켓몬 타입 아이콘 버튼 스타일 --- */
        .type-icon-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
        }
        .type-icon {
            padding: 10px;
            border-radius: 25px;
            text-align: center;
            color: white;
            font-weight: bold;
            cursor: pointer;
            border: 2px solid rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .type-icon:hover { transform: scale(1.05); }

        /* --- 상세 정보 스타일 --- */
        .detail-header { text-align: center; }
        .detail-header img { max-width: 150px; margin-bottom: 10px; }
        .detail-header h2 { color: var(--primary-color); }
        .detail-section { margin-bottom: 25px; }
        .detail-section h3 {
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 8px; margin-bottom: 12px;
            color: #c0392b; /* 소제목 색상 */
        }
        
        /* --- 모바일 반응형 --- */
        .top-controls { display: none; }
        @media (max-width: 768px) {
            body { padding-top: calc(var(--top-ad-banner-height) + 50px); }
            .top-controls {
                display: flex; justify-content: space-between;
                position: fixed; top: var(--top-ad-banner-height); left: 0; width: 100%;
                background-color: #2c3e50; color: white; padding: 10px 15px;
                z-index: 250; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            }
            .sidebar {
                position: fixed; top: 0; left: 0; height: 100%;
                transform: translateX(-100%); z-index: 200;
            }
            .sidebar.show { transform: translateX(0); }
            .app-container { height: calc(100vh - (var(--top-ad-banner-height) + 50px)); }
            .main-content { width: 100%; }
            .content-column { width: 100%; min-width: 100%; box-sizing: border-box; }
        }
    </style>
</head>
<body>
    <div class="top-ad-banner" id="top-ad-banner"></div>

    <div class="app-container">
        <aside class="sidebar" id="sidebar"></aside>
        <main class="main-content" id="main-content">
            <div class="content-column column-hidden" id="column-lev2"></div>
            <div class="content-column column-hidden" id="column-lev3"></div>
            <div class="content-column column-hidden" id="column-lev4"></div>
        </main>
    </div>

    <div class="top-controls">
        <button id="btn-menu">☰ 메뉴</button>
        <h2 id="mobile-title" style="margin:0; font-size:1.1em;"></h2>
        <button id="btn-back-mobile" style="display: none;">‹ 뒤로</button>
    </div>

    <script src="data.js"></script>
    <script>
        // --- 운영자 모드 및 무효 트래픽 방지 초기 설정 ---
        const isAdmin = new URLSearchParams(window.location.search).get('admin') === 'true';
        if (isAdmin) {
            console.log("운영자 모드 활성화: 광고가 표시되지 않습니다.");
        }

        // --- DOM 요소 ---
        const sidebarEl = document.getElementById('sidebar');
        const columns = {
            lev2: document.getElementById('column-lev2'),
            lev3: document.getElementById('column-lev3'),
            lev4: document.getElementById('column-lev4'),
        };
        const btnMenu = document.getElementById('btn-menu');
        const btnBackMobile = document.getElementById('btn-back-mobile');
        const mobileTitle = document.getElementById('mobile-title');

        let navigationStack = [];

        function goBack() {
            if (navigationStack.length > 0) {
                navigationStack.pop();
                renderView();
            }
        }
        
        function renderView() {
            const isMobile = window.innerWidth <= 768;
            Object.values(columns).forEach(col => col.classList.add('column-hidden'));

            if (navigationStack.length === 0) {
                btnBackMobile.style.display = 'none';
                mobileTitle.textContent = '메뉴 선택';
                if(isMobile) sidebarEl.classList.remove('show');
                return;
            }

            const currentState = navigationStack[navigationStack.length - 1];
            const config = categoryConfig[currentState.category];
            mobileTitle.textContent = currentState.key || config.title;

            // 상세 화면으로 전환 시 광고 새로고침
            if (config.renderType[currentState.level - 1] === 'detail') {
                refreshTopAd();
            }

            // 화면 렌더링 로직 (생략 - 이전과 동일)
            if (isMobile) {
                sidebarEl.classList.remove('show');
                const lastVisibleColumn = renderColumn(currentState);
                if (lastVisibleColumn) lastVisibleColumn.classList.remove('column-hidden');
            } else {
                const finalLevel = config.levels.length;
                if (currentState.level === finalLevel) {
                    const finalColumn = renderColumn(currentState);
                    if (finalColumn) finalColumn.classList.remove('column-hidden');
                } else {
                    navigationStack.forEach(state => {
                        const col = renderColumn(state);
                        if (col) col.classList.remove('column-hidden');
                    });
                }
            }
            btnBackMobile.style.display = navigationStack.length > 0 ? 'block' : 'none';
        }

        function renderColumn(state) {
            const { level, category, key } = state;
            const config = categoryConfig[category];
            if (!config || level > config.levels.length) return null;
            
            const columnEl = columns[config.levels[level-1]];
            columnEl.innerHTML = '';
            
            const backButtonPC = document.createElement('button');
            backButtonPC.className = 'btn-back-pc'; // CSS 클래스명 변경
            backButtonPC.textContent = '‹ 목록으로 돌아가기';
            backButtonPC.onclick = goBack;
            columnEl.appendChild(backButtonPC);
            if(level > 1) backButtonPC.style.display = 'block';

            const sourceData = database[config.dataKeys[level-1]];

            // 포켓몬 타입 아이콘 렌더링
            if (category === 'pokemonType' && level === 1) {
                const title = document.createElement('h2');
                title.textContent = config.title;
                columnEl.appendChild(title);
                const container = document.createElement('div');
                container.className = 'type-icon-container';
                Object.keys(sourceData).forEach(itemKey => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'type-icon';
                    itemEl.textContent = itemKey;
                    itemEl.style.backgroundColor = typeColors[itemKey] || '#ccc';
                    itemEl.onclick = () => handleItemClick(level + 1, category, itemKey);
                    container.appendChild(itemEl);
                });
                columnEl.appendChild(container);
            } // 일반 리스트 렌더링
            else if (config.renderType[level-1] === 'list') {
                const listData = (level === 1) ? Object.keys(sourceData) : (sourceData[key] || []);
                const title = document.createElement('h2');
                title.textContent = key || config.title;
                columnEl.appendChild(title);
                listData.forEach(itemKey => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'list-item';
                    itemEl.textContent = itemKey;
                    itemEl.onclick = () => handleItemClick(level + 1, category, itemKey);
                    columnEl.appendChild(itemEl);
                });
            } // 상세 정보 렌더링
            else if (config.renderType[level-1] === 'detail') {
                const detailData = sourceData[key];
                const contentDiv = document.createElement('div');
                if (detailData) {
                    contentDiv.innerHTML = config.detailRenderer(detailData);
                    columnEl.appendChild(contentDiv);
                }
            }
            return columnEl;
        }

        function handleItemClick(nextLevel, category, key) {
            navigationStack = navigationStack.filter(state => state.level < nextLevel);
            navigationStack.push({ level: nextLevel, category, key });
            renderView();
        }
        
        // --- AdSense 로직 ---
        const topAdBanner = document.getElementById('top-ad-banner');
        function refreshTopAd() {
            if (isAdmin || localStorage.getItem('adBlockUser') === new Date().toISOString().split('T')[0]) {
                topAdBanner.innerHTML = '<div style="color:#999; text-align:center;">운영자 모드 또는 어뷰징 방지 정책에 의해 광고가 숨김 처리되었습니다.</div>';
                return;
            }
            // 제공된 광고 코드를 여기에 삽입
            topAdBanner.innerHTML = `
                <ins class="adsbygoogle"
                     style="display:block"
                     data-ad-client="ca-pub-2125965839205311"
                     data-ad-slot="5532734526"
                     data-ad-format="auto"
                     data-full-width-responsive="true"></ins>
            `;
            try {
                (window.adsbygoogle = window.adsbygoogle || []).push({});
            } catch (e) {
                console.error("AdSense push Error:", e);
            }
        }

        function handleAdClick() {
            const now = new Date();
            const today = now.toISOString().split('T')[0]; // 'YYYY-MM-DD'
            const AD_CLICK_LIMIT = 5;
            const HOUR_IN_MS = 60 * 60 * 1000;
            
            let clickData = JSON.parse(localStorage.getItem('adClickData') || '{}');

            // 자정이 지나면 초기화
            if (clickData.date !== today) {
                clickData = { count: 0, time: 0, date: today };
            }

            if (!clickData.time || (now.getTime() - clickData.time > HOUR_IN_MS)) {
                clickData.count = 1;
                clickData.time = now.getTime();
            } else {
                clickData.count++;
            }
            
            if (clickData.count >= AD_CLICK_LIMIT) {
                console.warn(`광고 클릭 제한(${AD_CLICK_LIMIT}회) 초과. 오늘 하루 광고를 차단합니다.`);
                localStorage.setItem('adBlockUser', today); // 차단된 날짜를 저장
                refreshTopAd(); // 광고 즉시 숨김
            }
            localStorage.setItem('adClickData', JSON.stringify(clickData));
        }

        function init() {
            // 사이드바 생성
            sidebarEl.innerHTML = `<h1>포켓몬 정보</h1><ul class="nav-menu" id="main-nav">...</ul>`;
            // 이벤트 리스너 연결
            document.getElementById('main-nav').addEventListener('click', (e) => {
                if (e.target.tagName === 'LI') {
                    const category = e.target.dataset.category;
                    sidebarEl.querySelector('.active')?.classList.remove('active');
                    e.target.classList.add('active');
                    navigationStack = [{ level: 1, category }];
                    renderView();
                }
            });
            // 나머지 리스너들...
            btnBackMobile.addEventListener('click', goBack);
            btnMenu.addEventListener('click', () => sidebarEl.classList.toggle('show'));
            window.addEventListener('resize', renderView);
            
            // 광고 클릭 감지 리스너
            if (!isAdmin) {
                window.addEventListener('blur', () => {
                    // 0.5초 이내에 다시 포커스가 돌아오면 무시 (창 전환 등)
                    setTimeout(() => {
                        if (document.hasFocus()) return;
                        handleAdClick();
                    }, 500);
                });
            }

            refreshTopAd(); // 초기 광고 로드
            renderView();
        }

        // --- 초기화 ---
        init();
    </script>
</body>
</html>
